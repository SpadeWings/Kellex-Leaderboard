<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kellex Schools - Nova Vanguards Leaderboard</title>

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Particles.js for stars -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
</head>
<body>

  <!-- Particles.js Background -->
  <div id="particles-js"></div>

  <!-- Sun, Moon, Planet -->
  <!-- Sun Icon -->
  <svg class="sun" width="48" height="48" viewBox="0 0 512 512" fill="#FFB300">
    <path d="M256 118a22 22 0 01-22-22V48a22 22 0 0144 0v48a22 22 0 01-22 22zM256 486a22 22 0 01-22-22v-48a22 22 0 0144 0v48a22 22 0 01-22 22zM369.14 164.86a22 22 0 01-15.56-37.55l33.94-33.94a22 22 0 0131.11 31.11l-33.94 33.94a21.93 21.93 0 01-15.55 6.44zM108.92 425.08a22 22 0 01-15.55-37.56l33.94-33.94a22 22 0 0131.11 31.11l-33.94 33.94a21.94 21.94 0 01-15.56 6.45zM464 278h-48a22 22 0 010-44h48a22 22 0 010 44zM96 278H48a22 22 0 010-44h48a22 22 0 010 44zM403.08 425.08a21.94 21.94 0 01-15.56-6.45l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.55 37.56zM142.86 164.86a21.89 21.89 0 01-15.55-6.44l-33.94-33.94a22 22 0 0131.11-31.11l33.94 33.94a22 22 0 01-15.56 37.55zM256 358a102 102 0 11102-102 102.12 102.12 0 01-102 102z"/>
  </svg>

  <!-- Moon Icon -->
  <svg class="moon" width="48" height="48" viewBox="0 0 512 512" fill="#E0E0E0">
    <path d="M264 480A232 232 0 0132 248c0-94 54-178.28 137.61-214.67a16 16 0 0121.06 21.06C181.07 76.43 176 104.66 176 136c0 110.28 89.72 200 200 200 31.34 0 59.57-5.07 81.61-14.67a16 16 0 0121.06 21.06C442.28 426 358 480 264 480z"/>
  </svg>

  <!-- Planet 1 Icon -->
  <svg class="planet planet1" width="48" height="48" viewBox="0 0 512 512" fill="#42A5F5">
    <path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm0 368c-88.22 0-160-71.78-160-160S167.78 96 256 96s160 71.78 160 160-71.78 160-160 160z"/>
    <path d="M256 128c-10.45 0-19.15 7.33-19.15 17.75s8.7 17.75 19.15 17.75 19.15-7.33 19.15-17.75S266.45 128 256 128zM336 256c0 10.45-7.33 19.15-17.75 19.15s-17.75-8.7-17.75-19.15 7.33-19.15 17.75-19.15S336 245.55 336 256zM194.75 211.25c-10.45 0-17.75 7.3-17.75 17.75s7.3 17.75 17.75 17.75 17.75-7.3 17.75-17.75-7.3-17.75-17.75-17.75z"/>
  </svg>

  <!-- Planet 2 Icon -->
  <svg class="planet planet2" width="48" height="48" viewBox="0 0 512 512" fill="#EF5350">
    <path d="M256 48C141.13 48 48 141.13 48 256s93.13 208 208 208 208-93.13 208-208S370.87 48 256 48zm0 368c-88.22 0-160-71.78-160-160S167.78 96 256 96s160 71.78 160 160-71.78 160-160 160z"/>
    <path d="M256 128c-10.45 0-19.15 7.33-19.15 17.75s8.7 17.75 19.15 17.75 19.15-7.33 19.15-17.75S266.45 128 256 128zM336 256c0 10.45-7.33 19.15-17.75 19.15s-17.75-8.7-17.75-19.15 7.33-19.15 17.75-19.15S336 245.55 336 256zM194.75 211.25c-10.45 0-17.75 7.3-17.75 17.75s7.3 17.75 17.75 17.75 17.75-7.3 17.75-17.75-7.3-17.75-17.75-17.75z"/>
  </svg>
  <!-- Header -->
  <!-- Header -->
<header>
  <h1>Kellex Schools</h1>
  <h2>Nova Vanguards - Command Nexus</h2>
  <h3>Secondary Learners Leaderboard</h3>
</header>

<!-- Search/Filter Section -->
<div class="filter-container">
  <div class="search-box">
    <input type="text" id="nameFilter" placeholder="Search your name..." />
    <button id="filterButton">Search</button>
  </div>
  <div class="filter-options">
    <button class="filter-option active" data-filter="all">All</button>
    <button class="filter-option" data-filter="top10">Top 10</button>
    <button class="filter-option" data-filter="myScore">My Score</button>
  </div>
</div>

<main>
  <table id="leaderboardTable">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Class</th>
        <th>Score</th>
        <th>Change</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>

  <div id="leaderboardCards" class="cards-container"></div>
</main>

<!-- Coding Club Section -->
<section id="coding-club">
  <div class="club-container">
    <h2>Kellex Coding Club</h2>
    <div class="club-info">
      <p>Join our coding club to learn programming, develop games, build websites, and compete in coding challenges!</p>
      <div class="club-details">
        <div class="detail-item">
          <h3>Meeting Times</h3>
          <p>Every Wednesday, 1:10 PM - 2:20 PM</p>
        </div>
        <div class="detail-item">
          <h3>Location</h3>
          <p>Uholor Road off Airport Road, Benin City, Edo State</p>
        </div>
        <div class="detail-item">
          <h3>Instructor</h3>
          <p>Sir Paul</p>
        </div>
  </div>
</section>

<footer>
  <p>Sir Paul</p>
  <p>Computer Studies Teacher and Coding Club Instructor</p>
  <p>&copy; 2025</p>
</footer>

  <!-- Firebase + leaderboard JS -->
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBS_oX2uqItfNqd-7G9TSHnP-RUxviNLWc",
  authDomain: "leaderboard-900f1.firebaseapp.com",
  projectId: "leaderboard-900f1",
  storageBucket: "leaderboard-900f1.firebasestorage.app",
  messagingSenderId: "511470946131",
  appId: "1:511470946131:web:96bfb89e797a6bf12f03a6",
  measurementId: "G-WNNMR7PYYD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let previousScores = {};
let allLearnersData = [];
let currentFilter = "all";

// Performance optimization: Debounce function to limit Firebase requests
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Filter function
function applyFilter() {
  const searchTerm = document.getElementById('nameFilter').value.toLowerCase();
  const rows = document.querySelectorAll('#leaderboardBody tr, .learner-card');
  
  rows.forEach(row => {
    const nameElement = row.querySelector('.name');
    const shouldShow = !searchTerm || nameElement.textContent.toLowerCase().includes(searchTerm);
    row.style.display = shouldShow ? '' : 'none';
    
    if (shouldShow && searchTerm && nameElement.textContent.toLowerCase().includes(searchTerm)) {
      row.classList.add('highlighted');
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      row.classList.remove('highlighted');
    }
  });
}

async function loadLeaderboard() {
  try {
    const q = query(collection(db, "learners"), orderBy("score", "desc"));
    const snapshot = await getDocs(q);

    const tableBody = document.getElementById("leaderboardBody");
    const cardsContainer = document.getElementById("leaderboardCards");
    tableBody.innerHTML = "";
    cardsContainer.innerHTML = "";
    
    // Store all data for filtering
    allLearnersData = [];
    snapshot.forEach(doc => {
      allLearnersData.push({ id: doc.id, ...doc.data() });
    });

    let rank = 1;
    snapshot.forEach(doc => {
      const data = doc.data();
      const change = getChangeSymbol(data.name, data.score, previousScores[data.name]);
      previousScores[data.name] = data.score;

      const scoreHTML = renderScore(data.score);

      const row = document.createElement("tr");  

      let rankClass = '';
      let nameClass = '';
      if(rank === 1){ rankClass='rank-1'; nameClass='name-1'; }
      else if(rank === 2){ rankClass='rank-2'; nameClass='name-2'; }
      else if(rank === 3){ rankClass='rank-3'; nameClass='name-3'; }

      row.innerHTML = `
        <td class="${rankClass}">${rank}</td>
        <td class="name ${nameClass}">${data.name}</td>
        <td>${data.class}</td>
        <td>${scoreHTML}</td>
        <td>${change}</td>
      `;  
      tableBody.appendChild(row);

      const card = document.createElement("div");
      card.classList.add("learner-card");
      
      // Add specific class for top 3 cards
      if(rank === 1) card.classList.add('top-1');
      else if(rank === 2) card.classList.add('top-2');
      else if(rank === 3) card.classList.add('top-3');
      
      card.innerHTML = `
        <p class="rank">${rank}</p>
        <p class="name ${nameClass}">${data.name}</p>
        <p class="class">${data.class}</p>
        <p class="score">${scoreHTML}</p>
        <p class="change">${change}</p>
      `;
      cardsContainer.appendChild(card);

      rank++;
    });
  } catch (error) {
    console.error("Error loading leaderboard:", error);
  }
}

// Add to your score rendering function
function getScoreCategory(score) {
  if (score >= 1000) return { name: 'Nova Vanguard', class: 'nova' };
  if (score >= 500) return { name: 'Master', class: 'master' };
  if (score >= 200) return { name: 'Expert', class: 'expert' };
  if (score >= 50) return { name: 'Adept', class: 'adept' };
  if (score >= 10) return { name: 'Explorer', class: 'explorer' };
  return { name: 'Beginner', class: 'beginner' };
}

// Update your renderScore function to include the badge
function renderScore(score) {
  score = Number(score); // ensure it's a number
  
  let scoreClass = "score-0";
  if (score > 0 && score < 50) scoreClass = "score-1-49";
  else if (score >= 50 && score < 200) scoreClass = "score-50-199";
  else if (score >= 200 && score < 500) scoreClass = "score-200-499";
  else if (score >= 500 && score < 1000) scoreClass = "score-500-999";
  else if (score >= 1000) scoreClass = "score-1000";
  const category = getScoreCategory(score);
  
  if(score >= 1000) {
    return `<span class="score-num rainbow">${score} ‚≠ê <span class="score-badge ${category.class}">${category.name}</span></span>`;
  } else {
    return `<span class="score-num ${scoreClass}">${score} ‚≠ê <span class="score-badge ${category.class}">${category.name}</span></span>`;
  }
}

function getChangeSymbol(name, currentScore, lastScore) {
  if(lastScore === undefined) return '';
  if(currentScore > lastScore) return '<span class="up">‚¨ÜÔ∏è</span>';
  if(currentScore < lastScore) return '<span class="down">‚¨áÔ∏è</span>';
  return '<span class="no-change">‚ûñ</span>';
}

// Function to update a learner's score
async function updateLearnerScore(name, newScore) {
  try {
    const learnerRef = doc(db, "learners", name);
    const snapshot = await getDoc(learnerRef);
    
    if (snapshot.exists()) {
      const data = snapshot.data();
      await updateDoc(learnerRef, {
        lastScore: data.score, // Save the old score
        score: newScore        // Update with new score
      });
      
      console.log(`Updated ${name}'s score from ${data.score} to ${newScore}`);
      loadLeaderboard(); // Refresh the leaderboard
    } else {
      console.error("Learner not found");
    }
  } catch (error) {
    console.error("Error updating score:", error);
  }
}

// Initialize with debounced loading
const debouncedLoadLeaderboard = debounce(loadLeaderboard, 300);

// Initial load
debouncedLoadLeaderboard();

// Reduced polling interval for mobile
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
setInterval(debouncedLoadLeaderboard, isMobile ? 30000 : 10000);

// Add event listeners for filter functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add filter button event listener
  const filterButton = document.getElementById('filterButton');
  if (filterButton) {
    filterButton.addEventListener('click', applyFilter);
  }
  
  // Add Enter key support for search input
  const nameFilter = document.getElementById('nameFilter');
  if (nameFilter) {
    nameFilter.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') applyFilter();
    });
  }
});

// Example of how to update a score (you can call this from the console or from your admin interface)
// updateLearnerScore("John Doe", 250);
</script>

  <script>
    // Initialize particles after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Only initialize particles on desktop
      if (!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        let particleCount = window.innerWidth < 768 ? 30 : 80; // Reduced particles
        
        particlesJS("particles-js", {
          particles: {
            number: { value: particleCount, density: { enable: true, value_area: 800 } },
            color: { value: "#ffffff" },
            shape: { type:"circle" },
            opacity: { value:0.6, random:true, anim:{ enable:false }}, // Reduced animation
            size:{ value:2, random:true },
            line_linked:{ enable:false },
            move:{ enable:true, speed:0.5, direction:"none", random:true, straight:false, out_mode:"out" } // Reduced speed
          },
          interactivity:{ 
            detect_on:"canvas", 
            events:{ 
              onhover:{ enable:false }, 
              onclick:{ enable:false } 
            }
          },
          retina_detect:true
        });
      }
    });
  </script>
</body>
</html>
